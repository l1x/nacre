<!DOCTYPE html>
<html lang="en">
<head>
    {% include "_head.html" %}
</head>
<body>
    {% include "_header.html" %}
    <main id="content">
        <div class="task-detail">
            <a href="/tasks/{{ task.issue.id }}/edit" class="edit-action-btn">Edit</a>
            <div class="scandi-header" style="margin-bottom: 24px;">
                <div class="issue-eyebrow">
                    <span>{{ task.issue.id }}</span>
                    <span>&middot;</span>
                    <span>{{ task.issue.issue_type }}</span>
                </div>
                <h1 class="issue-title-large">{{ task.issue.title }}</h1>

                <div class="issue-meta-row">
                    <span class="meta-chip status-{{ task.issue.status.as_str() }}"><span class="meta-label">Status:</span> {{ task.issue.status }}</span>
                    <span class="meta-chip"><span class="meta-label">Priority:</span> P{{ task.issue.priority.unwrap_or(2) }}</span>

                    {% if let Some(assignee) = task.issue.assignee %}
                    <span class="meta-chip assignee"><span class="meta-label">Assignee:</span> {{ assignee }}</span>
                    {% endif %}
                </div>
            </div>

            {% if task.total > 0 %}
            <div class="detail-section" style="margin-bottom: 24px;">
                <h3>Progress</h3>
                <div class="progress-container large" style="margin-bottom: 8px;">
                    <div class="progress-bar" style="width: {{ task.percent }}%"></div>
                </div>
                <div style="text-align: right; font-size: 0.85rem; color: var(--text-muted);">
                    {{ task.closed }} / {{ task.total }} tasks completed ({{ "{:.0}"|format(task.percent) }}%)
                </div>
            </div>
            {% endif %}

            {% if let Some(description_html) = task.description_html %}
            <div class="detail-section">
                <h3>Description</h3>
                <div class="description-content">{{ description_html|safe }}</div>
            </div>
            {% endif %}
        </div>

        {% if !children_tree.is_empty() %}
        <div style="margin-top: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h3 style="margin: 0; color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Child Issues ({{ task.total }})</h3>
                    <div class="sort-controls" style="display: flex; gap: 4px; align-items: center;">
                        <span style="color: var(--text-muted); font-size: 0.75rem;">Sort:</span>
                        <button class="btn btn-secondary sort-btn" data-sort="status" title="Sort by Status" style="padding: 4px 12px; font-size: 0.75rem;">Status</button>
                        <button class="btn btn-secondary sort-btn" data-sort="type" title="Sort by Type" style="padding: 4px 12px; font-size: 0.75rem;">Type</button>
                        <button class="btn btn-secondary sort-btn" data-sort="priority" title="Sort by Priority" style="padding: 4px 12px; font-size: 0.75rem;">Priority</button>
                    </div>
                </div>
                {% if can_expand %}
                <div style="display: flex; gap: 8px;">
                    <button id="detail-expand" class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.75rem;">Expand</button>
                    <button id="detail-collapse" class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.75rem;">Collapse</button>
                </div>
                {% endif %}
            </div>
            
            <div class="tree-view" data-issue-type="{{ task.issue.issue_type }}">
                <ul class="tree-list">
                    {% for node in children_tree %}
                    <li class="tree-node depth-{{ node.depth }}"
                        data-id="{{ node.id }}"
                        data-depth="{{ node.depth }}"
                        data-type="{{ node.issue_type }}"
                        data-status="{{ node.status }}"
                        data-priority="{{ node.priority }}"
                        data-parent="{% if let Some(p) = node.parent_id %}{{ p }}{% endif %}"
                        data-has-children="{{ node.has_children }}"
                        data-filter-text="{{ node.title|lower }} {{ node.id|lower }}"
                        style="--depth: {{ node.depth }}">
                        <div class="tree-node-content">
                            {% if node.has_children %}
                            <button class="tree-toggle" aria-label="Toggle children">
                                <span class="toggle-icon">+</span>
                            </button>
                            {% else %}
                            <span class="tree-toggle-placeholder"></span>
                            {% endif %}
                            <span class="tree-status status-{{ node.status }}"></span>
                            <span class="tree-type type-{{ node.issue_type }}">{{ node.issue_type }}</span>
                            <a href="/tasks/{{ node.id }}" class="tree-title">{{ node.title }}</a>
                            <span class="tree-id">{{ node.id }}</span>
                            <span class="tree-priority">P{{ node.priority }}</span>
                            {% if node.blocked_by_count > 0 %}
                            <span class="tree-blocked" title="Blocked by {{ node.blocked_by_count }} issue(s)">
                                blocked
                            </span>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

        <div class="timestamps-grid" style="margin-top: 48px; margin-bottom: 24px;">
            <div class="timestamp-item">
                <span class="timestamp-value">{{ task.issue.created_at|format_date }}</span>
                <span class="timestamp-label">Created</span>
            </div>
            <div class="separator"></div>
            <div class="timestamp-item">
                <span class="timestamp-value">{{ task.issue.updated_at|format_date }}</span>
                <span class="timestamp-label">Updated</span>
            </div>
            {% if let Some(closed_at) = task.issue.closed_at %}
            <div class="separator"></div>
            <div class="timestamp-item">
                <span class="timestamp-value">{{ closed_at|format_date }}</span>
                <span class="timestamp-label">Closed</span>
            </div>
            {% endif %}
        </div>
    </main>
{% include "_footer.html" %}
</body>
</html>
